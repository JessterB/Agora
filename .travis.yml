sudo: required
dist: focal
language: node_js
cache:
  npm: false

addons:
  chrome: stable

branches:
  only:
    - develop
    - staging
    - prod

before_install:
  - npm install npm@8.11.0
  - npm cache verify
  - travis_retry npm prune

install:
  - npm install

before_script:
  - export NODE_OPTIONS=--max_old_space_size=4096

stages:
  - name: test
  - name: eb-deploy-develop
    if: (tag =~ ^v) OR (type = push) AND (branch = develop)
  - name: eb-deploy-staging
    if: (tag =~ ^v) OR (type = push) AND (branch = staging)
  - name: eb-deploy-prod
    if: (tag =~ ^v) OR (type = push) AND (branch = prod)

jobs:
  fast_finish: true
  include:
    - stage: test
      script: npm run ci:travis
      node_js: 16
    - stage: eb-deploy-develop
      script:
#        - ./scripts/set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          edge: true  # opt in to dpl v2
          cleanup: true
          bucket: org-sagebase-agora-deployment-agora-develop
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          app: agora-ampad
          env:
            develop: agora-develop
            DISABLE_OPENCOLLECTIVE: true
          wait_until_deployed: true
          access_key_id: AKIAY22FMBNE7T3Q36PT
          secret_access_key:
            secure: "p+eGGT6kNwb09F4WflqAv0HGSeANScD/SCeTf+77gryh1D4gAuK6HuL8j9DaqrhMT4HUt5KPU8PO27awGTRMgnTWg59fCkjjkd4Kn+1AqBICuqMMeo19dN9mLy7VJWwZDP+dmcnFDUZef0lpn4Lx6VwIpYfx4mzZ8lOR8JVwKMbd1fsyZCQPTmpBLlsH85wLAIIImuhnAOqToMb98O/yhDGikdEnxQ9RsGktzK/DgKsgpeWLLeKcwj/c71xKsO036hI7pj6MxgLItM5TVl4crv2v2RyZguCLyZsjj9Eqp+RNd9lV0CpXjbsRaauiH2gRVfxH+m//XW5bwpxRD7vCXhCX6G+aAw17ngvUN3SwfiJb7Y/F9F+PfKerz9Ef2D9t/nmBJYVOFxfYxClFSSZ7FV8kd+09/un4uqlx25izBAsJf4z6BADXCRIq/N+miSV+BEF28ubqKELsyTWd9kGE014l9Wl9Qk7pNK/04j6f6ekHT6628dRdmfrgGmWH/fzGwbij7BhfJNX42pfZ7GvoiLlpNHz1+V8lcqwOeZkP68IGh7XTpZfhe32fSYPyXvP2pdJ42pjV+yb8bFFEINLVI27vLiAfuxGR47jzIn6D2sV/RQMM8E2ytgpVU2RXfJ4jYo1sfeqcrjjNeQFfIscXS85y5HsEHSjjE23Jfxx4uwE="
    - stage: eb-deploy-staging
      script:
#        - ./set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          edge: true  # opt in to dpl v2
          cleanup: true
          bucket: org-sagebase-agora-deployment-agora-staging
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          app: agora-ampad
          env:
            staging: agora-staging
            DISABLE_OPENCOLLECTIVE: true
          wait_until_deployed: true
          access_key_id: AKIAZ5GJ3GCELHWLMUUX
          secret_access_key:
            secure: "e/Tr32Zyjm1loIvGUE2YNFXzfp3xbK2Ds/heaoPuEY/Haqp3G7fPSC3bCXMon8hrJyhK5WH/BY/FDnQBkC4b/yyTc39zngwSLJXVCaqJftR7b88FRe5B1H0X0sLSuOW4/Abx1BsQEcyicJN4TyeW6LXR4fLJjWxFvhltTd9eO08iu8n9XJecTEbGk8p4HaY9vvpOHDJT4u3ltIDtKuf1EJviLAgUn5dG47eeQDCrJFY1beqZXPUWn7nY1huf10s4pJpWSrBstHMJ21NhqBrBJPxm0eQ6XzelVudbqkKKcZ5uZ+NRw1ScAh9eIuDWJjKIN9QB5bGO7f1+MNWNKiWcweUBCV906AvcWhvDq6Xph3wkohKiUpTm5QarqhhkBRa8eYN5iht5KWgaAor4qFDGG4wAUe6uj8stjwSkqkoZP+vz/RTJTsVXtRZz2Y0LTyD4Skgo0/PB7riIhkFLzstSTShASQg9n9YCAfVfGdx0M97gnu/ypxEmCA5MPRKQuuP+BTF6DUi+8Gk3+kgvjyogbWE4Yl0p1kHm/efvjdIjpZ6CQ9eLmqivOzseYBg3NTDEmREjLHOT9IFUj6ooIMLySRlN0jF8oc/8l6+ycoV6Ai183GZ+GKuXkXtBMT0rWfCqKny2CxsXFTIwBjfRL5qRZjUA5M13AKg27BsQ6lvKQbo="
    - stage: eb-deploy-prod
      script:
#        - ./set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          edge: true  # opt in to dpl v2
          cleanup: true
          bucket: org-sagebase-agora-deployment-agora-prod
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          app: agora-ampad
          env:
            prod: agora-prod
            DISABLE_OPENCOLLECTIVE: true
          wait_until_deployed: true
          access_key_id: AKIAZ5GJ3GCELHWLMUUX
          secret_access_key:
            secure: "e/Tr32Zyjm1loIvGUE2YNFXzfp3xbK2Ds/heaoPuEY/Haqp3G7fPSC3bCXMon8hrJyhK5WH/BY/FDnQBkC4b/yyTc39zngwSLJXVCaqJftR7b88FRe5B1H0X0sLSuOW4/Abx1BsQEcyicJN4TyeW6LXR4fLJjWxFvhltTd9eO08iu8n9XJecTEbGk8p4HaY9vvpOHDJT4u3ltIDtKuf1EJviLAgUn5dG47eeQDCrJFY1beqZXPUWn7nY1huf10s4pJpWSrBstHMJ21NhqBrBJPxm0eQ6XzelVudbqkKKcZ5uZ+NRw1ScAh9eIuDWJjKIN9QB5bGO7f1+MNWNKiWcweUBCV906AvcWhvDq6Xph3wkohKiUpTm5QarqhhkBRa8eYN5iht5KWgaAor4qFDGG4wAUe6uj8stjwSkqkoZP+vz/RTJTsVXtRZz2Y0LTyD4Skgo0/PB7riIhkFLzstSTShASQg9n9YCAfVfGdx0M97gnu/ypxEmCA5MPRKQuuP+BTF6DUi+8Gk3+kgvjyogbWE4Yl0p1kHm/efvjdIjpZ6CQ9eLmqivOzseYBg3NTDEmREjLHOT9IFUj6ooIMLySRlN0jF8oc/8l6+ycoV6Ai183GZ+GKuXkXtBMT0rWfCqKny2CxsXFTIwBjfRL5qRZjUA5M13AKg27BsQ6lvKQbo="
